#!/bin/bash
PATH="$PWD/node_modules/.bin":$PATH
set -e

build() {
  set -x
  rm -rf dist
  mkdir dist
  # https://esbuild.github.io/api/#target
  cp -fv src/bin.js dist
  cp -fv README.md LICENSE dist
  npx pkgroll --target=es2020
  cat package.json | jq '.main = "./index.cjs"' |
    jq '.types = "./index.d.ts"' |
    jq '.exports.".".require = "./index.cjs"' |
    jq '.exports.".".types = "./index.d.ts"' |
    jq '.typesVersions."*".generate = ["./generate.d.ts"]' |
    jq '.exports."./generate".require = "./generate.cjs"' |
    jq '.exports."./generate".types = "./generate.d.ts"' \
      >dist/package.json
  set +x
}

compatibilty_check() {
  set -x
  rm -rf ./@generated && npm run prisma:g && npm run tscheck

  # Enable noAtomicOperations
  sed -i 's/noAtomicOperations *= false/noAtomicOperations = true/g' prisma/schema.prisma
  rm -rf ./@generated && npm run prisma:g && npm run tscheck
  sed -i 's/noAtomicOperations *= true/noAtomicOperations = false/g' prisma/schema.prisma

  # Enable combineScalarFilters
  sed -i 's/combineScalarFilters *= false/combineScalarFilters = true/g' prisma/schema.prisma
  rm -rf ./@generated && npm run prisma:g && npm run tscheck
  sed -i 's/combineScalarFilters *= true/combineScalarFilters = false/g' prisma/schema.prisma

  # Switching reExport
  sed -i 's/reExport *= None/reExport = All/g' prisma/schema.prisma
  rm -rf ./@generated && npm run prisma:g && npm run tscheck
  sed -i 's/reExport *= All/reExport = None/g' prisma/schema.prisma

  # emitSingle and emitCompiled
  sed -i 's/emitSingle *= false/emitSingle = true/g' prisma/schema.prisma
  rm -rf ./@generated && npm run prisma:g
  npx tsc --noEmit --skipLibCheck --experimentalDecorators ./@generated/index.ts
  npx ts-node ./@generated/index.ts

  sed -i 's/emitCompiled *= false/emitCompiled = true/g' prisma/schema.prisma
  rm -rf ./@generated && npm run prisma:g
  node ./@generated/index.js

  sed -i 's/emitCompiled *= true/emitCompiled = false/g' prisma/schema.prisma
  sed -i 's/emitSingle *= true/emitSingle = false/g' prisma/schema.prisma

  # requireSingleFieldsInWhereUniqueInput
  sed -i 's/requireSingleFieldsInWhereUniqueInput *= false/requireSingleFieldsInWhereUniqueInput = true/g' prisma/schema.prisma
  rm -rf ./@generated && npm run prisma:g && npm run tscheck
  sed -i 's/requireSingleFieldsInWhereUniqueInput *= true/requireSingleFieldsInWhereUniqueInput = false/g' prisma/schema.prisma

  set +x
}

commit_lint() {
  if git-branch-is -q -r "^(master)"; then
    commitlint --edit
  else
    true
  fi
}

commit_check() {
  set -x
  from=$(git_last_release_tag)
  commitlint --from $from
}

"$@"
